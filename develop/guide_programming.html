<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Siuba - Programming guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../develop/sql-translators.html" rel="next">
<link href="../develop/backend_pandas.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Siuba</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../guide/overview.html">Guide</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../api/">Reference</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../examples/index.html">Examples</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">About</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../about/key_features.html">
 <span class="dropdown-text">Key features</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../develop/index.html">
 <span class="dropdown-text">Developing siuba</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/machow/siuba/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Programming guide</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/index.html" class="sidebar-item-text sidebar-link">Developing siuba</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Backends</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/backend_sql.html" class="sidebar-item-text sidebar-link">SQL backend</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/backend_pandas.html" class="sidebar-item-text sidebar-link">Pandas backend</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Core</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/guide_programming.html" class="sidebar-item-text sidebar-link active">Programming guide</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/sql-translators.html" class="sidebar-item-text sidebar-link">SQL translators</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/call_trees.html" class="sidebar-item-text sidebar-link">Call tree processing</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../develop/pandas-group-ops.html" class="sidebar-item-text sidebar-link">Optimized grouped pandas ops</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#programming-guide" id="toc-programming-guide" class="nav-link active" data-scroll-target="#programming-guide">Programming guide</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#column-operations" id="toc-column-operations" class="nav-link" data-scroll-target="#column-operations">Column operations</a></li>
  <li><a href="#table-verbs" id="toc-table-verbs" class="nav-link" data-scroll-target="#table-verbs">Table verbs</a>
  <ul class="collapse">
  <li><a href="#grouped-data" id="toc-grouped-data" class="nav-link" data-scroll-target="#grouped-data">Grouped data</a></li>
  <li><a href="#handling-indexes" id="toc-handling-indexes" class="nav-link" data-scroll-target="#handling-indexes">Handling indexes</a></li>
  <li><a href="#singledispatch2" id="toc-singledispatch2" class="nav-link" data-scroll-target="#singledispatch2">singledispatch2</a></li>
  </ul></li>
  <li><a href="#pipe-syntax" id="toc-pipe-syntax" class="nav-link" data-scroll-target="#pipe-syntax">Pipe syntax</a>
  <ul class="collapse">
  <li><a href="#groups-verbs-and-operations" id="toc-groups-verbs-and-operations" class="nav-link" data-scroll-target="#groups-verbs-and-operations">Groups, verbs, and operations</a></li>
  <li><a href="#pipeable-class" id="toc-pipeable-class" class="nav-link" data-scroll-target="#pipeable-class">Pipeable class</a></li>
  </ul></li>
  <li><a href="#lazy-expressions" id="toc-lazy-expressions" class="nav-link" data-scroll-target="#lazy-expressions">Lazy expressions</a>
  <ul class="collapse">
  <li><a href="#what-vs-how" id="toc-what-vs-how" class="nav-link" data-scroll-target="#what-vs-how">What vs how</a></li>
  <li><a href="#symbolic-and-call" id="toc-symbolic-and-call" class="nav-link" data-scroll-target="#symbolic-and-call">Symbolic and Call</a></li>
  <li><a href="#user-defined-functions" id="toc-user-defined-functions" class="nav-link" data-scroll-target="#user-defined-functions">User defined functions</a></li>
  <li><a href="#caveats" id="toc-caveats" class="nav-link" data-scroll-target="#caveats">Caveats</a></li>
  </ul></li>
  <li><a href="#translating-operations" id="toc-translating-operations" class="nav-link" data-scroll-target="#translating-operations">Translating operations</a>
  <ul class="collapse">
  <li><a href="#example-replace_attr" id="toc-example-replace_attr" class="nav-link" data-scroll-target="#example-replace_attr">Example: replace_attr</a></li>
  <li><a href="#callvisitor" id="toc-callvisitor" class="nav-link" data-scroll-target="#callvisitor">CallVisitor</a></li>
  </ul></li>
  <li><a href="#backends" id="toc-backends" class="nav-link" data-scroll-target="#backends">Backends</a></li>
  <li><a href="#nested-data" id="toc-nested-data" class="nav-link" data-scroll-target="#nested-data">Nested data</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Programming guide</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<div class="cell" data-nbsphinx="hidden" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_rows"</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="programming-guide" class="level1">
<h1>Programming guide</h1>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to get started analyzing data, see the <a href="../guide">guide</a>. This guide gives an overview of how to implement and extend most parts of siuba. It also discusses the rationale behind siuba’s architecture.</p>
</div>
</div>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This document can be thought of as roughly having two segments. The core <strong>analysis interface</strong> gives users flexibility to independently specify data groupings, table verbs, and column operations. It also highlights a critical piece of siuba’s design–that its column operations correspond to pandas Series methods.</p>
<p>Here’s an example of this interface in use, colored with links the relevant sections.</p>
<p><img src="_assets/guide-siuba-pipe.svg" class="img-fluid"></p>
<p>The <strong>lazy execution</strong> interface allows users to declare <strong>what</strong> they want to perform, so developers can create backends to optimize <strong>how</strong> to execute it on different data sources (e.g.&nbsp;SQL).</p>
<p><img src="_assets/guide-classes-general.svg" class="img-fluid"></p>
</section>
<section id="column-operations" class="level2">
<h2 class="anchored" data-anchor-id="column-operations">Column operations</h2>
<p>In general, column operations in siuba are pandas Series methods.</p>
<p>For example, the code below compares two ways to produce the same result: the <code>DataFrame.assign()</code> method, and siuba’s <code>mutate()</code> function.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.data <span class="im">import</span> cars</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> mutate</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pandas assign method</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>cars.assign( demean <span class="op">=</span> <span class="kw">lambda</span> d: d.mpg <span class="op">-</span> d.mpg.mean())</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># siuba mutate function</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>mutate(cars, demean <span class="op">=</span> <span class="kw">lambda</span> d: d.mpg <span class="op">-</span> d.mpg.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>demean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>0.909375</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>0.909375</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>8</td>
      <td>15.0</td>
      <td>335</td>
      <td>-5.090625</td>
    </tr>
    <tr>
      <th>31</th>
      <td>4</td>
      <td>21.4</td>
      <td>109</td>
      <td>1.309375</td>
    </tr>
  </tbody>
</table>
<p>32 rows × 4 columns</p>
</div>
</div>
</div>
<p>Note that both are using pandas Series methods under the hood. This means that you can use and debug Series methods just like you would with pandas.</p>
<p>For <strong>grouped data</strong>, or a <strong>SQL database</strong>, siuba can’t use Series methods because they don’t exist. For example, on grouped data, the same operation above in pandas would be..</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create grouped data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>g_cyl <span class="op">=</span> cars.groupby(<span class="st">'cyl'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># error: g_cyl doesn't have an .assign method! :/</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># g_cyl.assign</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>cars.assign(demean <span class="op">=</span> g_cyl.mpg.transform(<span class="kw">lambda</span> x: x <span class="op">-</span> x.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>demean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>1.257143</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>1.257143</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>8</td>
      <td>15.0</td>
      <td>335</td>
      <td>-0.100000</td>
    </tr>
    <tr>
      <th>31</th>
      <td>4</td>
      <td>21.4</td>
      <td>109</td>
      <td>-5.263636</td>
    </tr>
  </tbody>
</table>
<p>32 rows × 4 columns</p>
</div>
</div>
</div>
<p>In this case, the siuba code works similar to the pandas code above, but stays the same as in the ungrouped example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mutate(g_cyl, demean <span class="op">=</span> <span class="kw">lambda</span> d: d.mpg <span class="op">-</span> d.mpg.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For SQL, it needs to go through a process to convert it to a SQL query using SQLAlchemy. One key step in this process is understanding how siuba can work on a DataFrame or a SQLAlchemy connection.</p>
</section>
<section id="table-verbs" class="level2">
<h2 class="anchored" data-anchor-id="table-verbs">Table verbs</h2>
<p>You may be wondering how a siuba function, like mutate, could work on a SQL database. This is because these functions are defined using a technique called single dispatch. This approach allows you to define class-specific versions of a function.</p>
<p>The code below creates a function called <code>head()</code>, with an implementation that works specifically on a DataFrame.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.dply.verbs <span class="im">import</span> singledispatch2</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrame version of function ---</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">@singledispatch2</span>(pd.DataFrame)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> head(__data, n <span class="op">=</span> <span class="dv">5</span>):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> __data.head(n)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>head(cars, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We can define a SQL specific version, that acts on a SqlAlchemy Table by registering a new function, <code>_head_sql</code>.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SQL version of function ---</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> Table, Column, MetaData</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">@head.register</span>(Table)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _head_sql(__data, n <span class="op">=</span> <span class="dv">5</span>):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> __data.select().limit(n)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> Table(<span class="st">"some_table"</span>, MetaData(), Column(<span class="st">'a'</span>), Column(<span class="st">'b'</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    head(table, <span class="dv">2</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SELECT some_table.a, some_table.b 
FROM some_table
 LIMIT :param_1</code></pre>
</div>
</div>
<p>why use singledispatch rather than a class method like <code>mtcars.head()</code>?</p>
<p>There are two big benefits:</p>
<ol type="1">
<li><strong>Anyone can cleanly define and package a function</strong>. Using it is just a matter of importing it. With a method, you need to somehow put it onto the class representing your data. You end up with 300+ methods on a class.</li>
<li>Your function might do something that is <strong>not the class’s core responsibility</strong>. In this case, it should not be part of the class definition.</li>
</ol>
<section id="grouped-data" class="level3">
<h3 class="anchored" data-anchor-id="grouped-data">Grouped data</h3>
<p>Since single dispatch functions define how to execute an action for a specific class of data, it allows siuba to handle grouped data in two ways:</p>
<ul>
<li>pandas - register dispatchers for its special grouped data classes (<code>DataFrameGroupBy</code>, <code>SeriesGroupBy</code>).</li>
<li>SQL - use a single class for grouped and ungrouped data, with grouping info as an attribute (<code>siuba.sql.LazyTbl</code>).</li>
</ul>
<p>For example, here is a simple verb that calculates the number of rows in a grouped DataFrame.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.core.groupby <span class="im">import</span> DataFrameGroupBy</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">@singledispatch2</span>(DataFrameGroupBy)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> size(__data):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> __data.size()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>size(cars.groupby(<span class="st">'cyl'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>cyl
4    11
6     7
8    14
dtype: int64</code></pre>
</div>
</div>
</section>
<section id="handling-indexes" class="level3">
<h3 class="anchored" data-anchor-id="handling-indexes">Handling indexes</h3>
<p>Most siuba table verbs take a DataFrame, and return a DataFrame. Moreover, they don’t stick columns onto the index. This means you don’t need to call <code>reset_index</code> all the time.</p>
<p>A common place where <code>reset_index</code> is called is after a pandas grouped aggregation.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.data <span class="im">import</span> mtcars</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> summarize</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>g_cyl <span class="op">=</span> mtcars.groupby(<span class="st">"cyl"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>agg_res <span class="op">=</span> g_cyl[[<span class="st">"hp"</span>, <span class="st">"mpg"</span>]].agg(<span class="st">"mean"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># nooooo</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>agg_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>hp</th>
      <th>mpg</th>
    </tr>
    <tr>
      <th>cyl</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>82.636364</td>
      <td>26.663636</td>
    </tr>
    <tr>
      <th>6</th>
      <td>122.285714</td>
      <td>19.742857</td>
    </tr>
    <tr>
      <th>8</th>
      <td>209.214286</td>
      <td>15.100000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># good</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>summarize(g_cyl, hp <span class="op">=</span> _.hp.mean(), mpg <span class="op">=</span> _.mpg.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>hp</th>
      <th>mpg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>138.045455</td>
      <td>20.502165</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>138.045455</td>
      <td>20.502165</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8</td>
      <td>138.045455</td>
      <td>20.502165</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="singledispatch2" class="level3">
<h3 class="anchored" data-anchor-id="singledispatch2">singledispatch2</h3>
<p>One thing to note is that siuba’s singledispatch implementation is called <code>singledispatch2</code>. This function (whose name will likely change!) is a very light wrapper around python’s built in <code>functools.singledispatch</code> that does two things:</p>
<ol type="1">
<li>Allow verbs to be piped using <code>data &gt;&gt; verb1() &gt;&gt; verb2()</code> syntax.</li>
<li>Strip out the symbolic part of lazy expressions.</li>
</ol>
<p>These two concepts are covered in the next two sections.</p>
</section>
</section>
<section id="pipe-syntax" class="level2">
<h2 class="anchored" data-anchor-id="pipe-syntax">Pipe syntax</h2>
<p>In the previous section I discussed how siuba uses singledispatch. This allows people to define new functions that are easy to package and import, as well as handle both a pandas DataFrame and SqlAlchemy table.</p>
<p>One challenge with using functions, rather than methods, is finding a way to combine them so they can be read from left to right, or top to bottom. In pandas this is done using method chaining. For example, the code below starts with <code>cars</code>, then runs <code>.assign()</code>, then runs <code>.head()</code>.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(cars</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  .assign(hp_per_cyl <span class="op">=</span> <span class="kw">lambda</span> d: d.hp <span class="op">/</span> d.cyl)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  .head(<span class="dv">2</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>hp_per_cyl</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Here is a similar version in siuba of the above code without piping.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> head, mutate</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># without pipe ----</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>head(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    mutate(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        cars,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        hp_per_cyl <span class="op">=</span> <span class="kw">lambda</span> d: d.hp <span class="op">/</span> d.cyl</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>hp_per_cyl</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Notice how head is run last in our method chain, but is the outer most function call. We have to read the calls inside out, and it’s hard to quickly spot the beginning (<code>cars</code>) and the end (<code>head</code>). This has been described as the <a href="http://wiki.c2.com/?ThickBreadSmell">dagwood sandwich</a> problem.</p>
<p>In siuba, this is resolved by overloading <code>&gt;&gt;</code> to create pipes.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with pipe ----</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>(cars</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> mutate(hp_per_cyl <span class="op">=</span> <span class="kw">lambda</span> d: d.hp <span class="op">/</span> d.cyl)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> head(<span class="dv">2</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>hp_per_cyl</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>18.333333</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Notice also how in these cases we can import just the head and mutate functions. They are separated from the data classes (DataFrame, SQL source) that they can act on.</p>
<section id="groups-verbs-and-operations" class="level3">
<h3 class="anchored" data-anchor-id="groups-verbs-and-operations">Groups, verbs, and operations</h3>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> group_by, mutate, <span class="bu">filter</span>, _</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>grouping <span class="op">=</span> group_by(<span class="st">"cyl"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>verb1 <span class="op">=</span> mutate</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>verb2 <span class="op">=</span> <span class="bu">filter</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>operation <span class="op">=</span> <span class="kw">lambda</span> _: _.hp <span class="op">&gt;</span> _.hp.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cars <span class="op">&gt;&gt;</span> grouping <span class="op">&gt;&gt;</span> verb1(result <span class="op">=</span> operation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">

<div><p>(grouped data frame)</p><div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
      <th>result</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>21.0</td>
      <td>110</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>8</td>
      <td>15.0</td>
      <td>335</td>
      <td>True</td>
    </tr>
    <tr>
      <th>31</th>
      <td>4</td>
      <td>21.4</td>
      <td>109</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>32 rows × 4 columns</p>
</div></div>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cars <span class="op">&gt;&gt;</span> grouping <span class="op">&gt;&gt;</span> verb2(operation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">

<div><p>(grouped data frame)</p><div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cyl</th>
      <th>mpg</th>
      <th>hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>22.8</td>
      <td>93</td>
    </tr>
    <tr>
      <th>6</th>
      <td>8</td>
      <td>14.3</td>
      <td>245</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>8</td>
      <td>15.0</td>
      <td>335</td>
    </tr>
    <tr>
      <th>31</th>
      <td>4</td>
      <td>21.4</td>
      <td>109</td>
    </tr>
  </tbody>
</table>
<p>15 rows × 3 columns</p>
</div></div>
</div>
</div>
</section>
<section id="pipeable-class" class="level3">
<h3 class="anchored" data-anchor-id="pipeable-class">Pipeable class</h3>
<p>Under the hood, function calls like below are turned into a Pipeable object.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mutate(hp_per_cyl <span class="op">=</span> <span class="kw">lambda</span> d: d.hp <span class="op">/</span> d.cyl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>&lt;function mutate at 0x7f3cb8b8fdc0&gt;(_,hp_per_cyl = &lt;function &lt;lambda&gt; at 0x7f3cb8b22430&gt;())</code></pre>
</div>
</div>
<p>There are two <strong>implicit</strong> cases that create a Pipeable.</p>
<ol type="1">
<li>The function receives no positional arguments</li>
<li>The function’s first positional argument is not a registered data source, like a DataFrame or SQL database.</li>
</ol>
<p>Alternatively, you can <strong>explicitly</strong> create a pipe by passing an instance of siuba’s Symbolic class. This is shown in the code below.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> _</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>mutate(_, hp_per_cyl <span class="op">=</span> <span class="kw">lambda</span> d: d.hp <span class="op">/</span> d.cyl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;function mutate at 0x7f3cb8b8fdc0&gt;(_,hp_per_cyl = &lt;function &lt;lambda&gt; at 0x7f3cb0f820d0&gt;())</code></pre>
</div>
</div>
<p>In this case, we are taking advantage of siuba’s lazy expressions, and using <code>_</code> as a “placeholder” for the data. Since <code>_</code> is an instance of the <code>Symbolic</code> class, this is just using single dispatch with one small twist.</p>
<p>The code below shows all the classes mutate can dispatch on.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(mutate.registry.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>[object,
 pandas.core.frame.DataFrame,
 siuba.siu.calls.Call,
 siuba.siu.dispatchers.NoArgs,
 pandas.core.groupby.generic.DataFrameGroupBy]</code></pre>
</div>
</div>
<p>Note that <code>Symbolic</code> isn’t in the list, but something called a <code>Call</code> is. The twist is that siuba’s <code>singledispatch2</code> strips down the <code>Symbolic</code> to something less useful to users, but safer to work with: a <code>Call</code>.</p>
<p>The path from Symbolic to Pipeable is shown below.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this stripping down is done by singledispatch2</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> strip_symbolic, _</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>sym <span class="op">=</span> _                         <span class="co"># a Symbolic</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>call <span class="op">=</span> strip_symbolic(sym)      <span class="co"># a Call</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dispatching on Call to create a pipeable</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>mutate(call)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>&lt;function mutate at 0x7f3cb8b8fdc0&gt;(_)</code></pre>
</div>
</div>
<p>The following section explains the relationship between <code>Symbolic</code> and <code>Call</code>, and how they enable lazy expressions.</p>
</section>
</section>
<section id="lazy-expressions" class="level2">
<h2 class="anchored" data-anchor-id="lazy-expressions">Lazy expressions</h2>
<p>Together with single dispatch and pipes, lazy expressions allow you to separate declaring <strong>what</strong> actions to perform, from <strong>how</strong> to perform those actions.</p>
<p>Up to this point, we’ve used lambda functions to express operations on a DataFrame’s columns, but we could have used lazy expressions with <code>_</code>.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> _, summarize</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># lambda approach</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>summarize(cars, hp_mean <span class="op">=</span> <span class="kw">lambda</span> d: d.hp.mean())</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># lazy expression approach</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>summarize(cars, avg_hp <span class="op">=</span> _.hp.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>avg_hp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>146.6875</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Peppering an analysis with lambda functions creates two challenges:</p>
<ol type="1">
<li>writing <code>lambda d:</code> can take up as many characters as its operation.</li>
<li>lambdas can lazily do some work, but they can’t tell us <strong>what</strong> work they will do.</li>
</ol>
<section id="what-vs-how" class="level3">
<h3 class="anchored" data-anchor-id="what-vs-how">What vs how</h3>
<p>Consider this symbolic, lazy expression below.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> _.hp.mean()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>█─'__call__'
└─█─.
  ├─█─.
  │ ├─_
  │ └─'hp'
  └─'mean'</code></pre>
</div>
</div>
<p>Its print-out represents the expression as an abstract syntax tree (AST).</p>
<p>This means we can either choose to execute <code>f</code> like a function.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>f(cars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>146.6875</code></pre>
</div>
</div>
<p>Or run something over it that can analyze and transform the AST.</p>
<div class="cell" data-nbsphinx="hidden" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: this cell is hidden</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> strip_symbolic, Call, _, BinaryOp</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> replace_attr(call, src, dst):</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># just in case we pass a Symbolic</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    call <span class="op">=</span> strip_symbolic(call)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that is _.&lt;src&gt;, or the last part of _.abc.&lt;src&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call.func <span class="op">==</span> <span class="st">"__getattr__"</span> <span class="kw">and</span> call.args[<span class="dv">1</span>] <span class="op">==</span> src:</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># eg: obj = _, src_attr = "hp"</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        obj, src_attr <span class="op">=</span> call.args</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recreate call, but with dst as the attribute</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BinaryOp(<span class="st">"__getattr__"</span>, obj, dst)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> call.map_replace(<span class="kw">lambda</span> child: replace_attr(child, src, dst))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replace mpg with hp</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>new_f <span class="op">=</span> replace_attr(_.hp.mean() <span class="op">/</span> _.cyl, <span class="st">'hp'</span>, <span class="st">'mpg'</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>new_f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>_.mpg.mean() / _.cyl</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>new_f(cars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>0     3.348438
1     3.348438
        ...   
30    2.511328
31    5.022656
Name: cyl, Length: 32, dtype: float64</code></pre>
</div>
</div>
<p>As a more involved example, here is some code that generates a SQL query.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.data <span class="im">import</span> cars_sql</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> siuba.sql</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba <span class="im">import</span> show_query</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> (cars_sql </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> group_by(<span class="st">"cyl"</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> mutate(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>       demeaned <span class="op">=</span> _.hp <span class="op">-</span> _.hp.mean(),</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>       mpg_per_hp <span class="op">=</span> _.mpg <span class="op">/</span> _.hp,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> show_query()</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SELECT cars.cyl, cars.mpg, cars.hp, cars.hp - avg(cars.hp) OVER (PARTITION BY cars.cyl) AS demeaned, CAST(cars.mpg AS FLOAT) / cars.hp AS mpg_per_hp 
FROM cars</code></pre>
</div>
</div>
<p>In this section, we’ll discuss in detail the two classes that make declaring <strong>what</strong> possible–Symbolic and Call. In the <a href="#Translating-operations">next section</a> we’ll go over the code for the <code>replace_attr</code> function, and the tools that make generating the SQL query above possible.</p>
</section>
<section id="symbolic-and-call" class="level3">
<h3 class="anchored" data-anchor-id="symbolic-and-call">Symbolic and Call</h3>
<p>Lazy expressions are implemented through two classes:</p>
<ul>
<li>Call: the actual representation of a lazy expression</li>
<li>Symbolic: a convenience class to quickly create Calls</li>
</ul>
<p>The code below shows the action <code>data.a + 1</code> created using only the Call approach.</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># call approach</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> BinaryOp, MetaArg</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>BinaryOp(<span class="st">"__add__"</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    BinaryOp(<span class="st">"__getattr__"</span>, MetaArg(<span class="st">"_"</span>), <span class="st">"a"</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>_.a + 1</code></pre>
</div>
</div>
<p>And again using the Symbolic instance, <code>_</code>.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> _, strip_symbolic</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>strip_symbolic(_.a <span class="op">+</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>_.a + 1</code></pre>
</div>
</div>
<p>Note that a Symbolic’s only job is to create Calls, so <code>strip_symbolic</code> is just getting the Call out (it is a “private” property).</p>
</section>
<section id="user-defined-functions" class="level3">
<h3 class="anchored" data-anchor-id="user-defined-functions">User defined functions</h3>
<p>Declaring operations like <code>_.some_method()</code> is enough for most cases, but sometimes a person might want to use an external function.</p>
<p>For example, siuba comes with functions that aren’t covered by pandas methods, or that work in a different way.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.dply.vector <span class="im">import</span> n</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>n(_.hp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>█─'__call__'
├─█─'__custom_func__'
│ └─&lt;function n at 0x7f3cb0d900d0&gt;
└─█─.
  ├─_
  └─'hp'</code></pre>
</div>
</div>
<p>In this case, the function <code>n()</code> is represented as a simple subtype of Call, called a FuncArg.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> Call, FuncArg, Symbolic</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>func_arg <span class="op">=</span> Symbolic(FuncArg(<span class="st">"__custom_func__"</span>, n))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>func_arg(_.hp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>█─'__call__'
├─█─'__custom_func__'
│ └─&lt;function n at 0x7f3cb0d900d0&gt;
└─█─.
  ├─_
  └─'hp'</code></pre>
</div>
</div>
<p>Similar to piping, this happens because functions like <code>n</code> are defined using singledispatch called <code>symbolic_dispatch</code>. When a function using <code>symbolic_dispatch</code> receives a Symbolic or Call as its first argument, it returns a Symbolic.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> symbolic_dispatch</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="at">@symbolic_dispatch</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> another_n(x):</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>another_n([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>3</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>another_n(_.a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>█─'__call__'
├─█─'__custom_func__'
│ └─&lt;function another_n at 0x7f3cb0cdbdc0&gt;
└─█─.
  ├─_
  └─'a'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>sym <span class="op">=</span> another_n(_.a)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>sym(pd.DataFrame({<span class="st">'a'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>3</code></pre>
</div>
</div>
<p>This is a simple wrapper around python’s singledispatch, so you can use all the tools that come with it. The most useful is printing out the classes that it can dispatch on.</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>another_n.registry.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>dict_keys([&lt;class 'object'&gt;, &lt;class 'siuba.siu.symbolic.Symbolic'&gt;, &lt;class 'siuba.siu.calls.Call'&gt;])</code></pre>
</div>
</div>
</section>
<section id="caveats" class="level3">
<h3 class="anchored" data-anchor-id="caveats">Caveats</h3>
<p>siuba’s lazy expressions open a whole range of behaviors, including implementing new execution backends. However, there are some limitations to their use, compared to lambda functions.</p>
<p><strong>First,</strong> they are not guaranteed to work inside a function that does not know about Symbolics. In these cases you can switch back to a lambda.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">'date_raw'</span>: [<span class="st">'2019-01-01'</span>]})</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># not okay</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>pd.to_datetime(_.date_raw)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># okay</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="kw">lambda</span> _: pd.to_datetime(_.date_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Often there is an alternative method that will do the same thing.</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">'date_raw'</span>: [<span class="st">'2019-01-01'</span>]})</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>df.date_raw.astype(<span class="st">"datetime64[ns]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>0   2019-01-01
Name: date_raw, dtype: datetime64[ns]</code></pre>
</div>
</div>
<p>This limitation can be thought of as similar to pandas asking for method names to be strings some times. In pandas, this is due to not using lazy expressions, while in siuba the limitations are for the opposite reason!</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>cars.groupby(<span class="st">'cyl'</span>).hp.transform(<span class="st">'mean'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0     122.285714
1     122.285714
         ...    
30    209.214286
31     82.636364
Name: hp, Length: 32, dtype: float64</code></pre>
</div>
</div>
<p><strong>Second</strong>, outside of siuba functions, Symbolic cannot be called like a lambda when it ends with getting an attribute.</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not okay, . is outermost (final) operation</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>(_ <span class="op">+</span> _).x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>█─.
├─█─+
│ ├─_
│ └─_
└─'x'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># okay</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>_.x <span class="op">+</span> _.y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>█─+
├─█─.
│ ├─_
│ └─'x'
└─█─.
  ├─_
  └─'y'</code></pre>
</div>
</div>
<p>Note that for functions created through <code>singledispatch2</code> or <code>symbolic_dispatch</code>, any Symbolic is fine.</p>
<p><strong>Third</strong>, they can’t work with Python methods that are required to return booleans. This includes methods like <code>__and__</code>. For the most part, this is similar to the restrictions around numpy arrays and pandas Series.</p>
<div class="cell" data-nbsphinx="{&quot;allow_errors&quot;:true}" data-tags="[&quot;raises-exception&quot;]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># should use: _ &amp;&amp; 1</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>_ <span class="kw">and</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>TypeError: Symbolic objects can not be converted to True/False, or used with these keywords: not, and, or.</code></pre>
</div>
</div>
<p>One case where this uniquely bites Symbolics is <code>__contains__</code>, but siuba is careful to raise an error.</p>
<div class="cell" data-nbsphinx="{&quot;allow_errors&quot;:true}" data-tags="[&quot;raises-exception&quot;]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">in</span> _</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>TypeError: 'Symbolic' object is not a container</code></pre>
</div>
</div>
</section>
</section>
<section id="translating-operations" class="level2">
<h2 class="anchored" data-anchor-id="translating-operations">Translating operations</h2>
<p>You may have noticed in previous sections that some features–like fast pandas grouped operations and executing SQL–require declaring what you want to do with <code>_</code>. Ultimately, when you write an operation like <code>_.a + _.b</code>, it results in a new Symbolic object that can do two things.</p>
<ol type="1">
<li>be executed like a lambda</li>
<li>allow self-representation</li>
</ol>
<p>This representation is called an Abstract Syntax Tree (AST).</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>symbol <span class="op">=</span> _.a <span class="op">+</span> _.b</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>symbol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>█─+
├─█─.
│ ├─_
│ └─'a'
└─█─.
  ├─_
  └─'b'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> strip_symbolic</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>call <span class="op">=</span> strip_symbolic(symbol)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>call</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>_.a + _.b</code></pre>
</div>
</div>
<p>A call has three attributes</p>
<ul>
<li>func: the function being called (eg <code>__add__</code> for addition)</li>
<li>args: positional arguments passed to the call</li>
<li>kwargs: keyword arguments passed to the call</li>
</ul>
<p>This makes it very easy to inspect and modify. For example, we could change the function from addition to subtraction.</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>call.func <span class="op">=</span> <span class="st">'__sub__'</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>call</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>_.a - _.b</code></pre>
</div>
</div>
<p>Note that in practice, calls should not be modified in place like that. They also often contain other calls, shown as black boxes on the AST below.</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>_.hp <span class="op">/</span> _.mpg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>█─/
├─█─.
│ ├─_
│ └─'hp'
└─█─.
  ├─_
  └─'mpg'</code></pre>
</div>
</div>
<p>Here, the top level call is a division (<code>/</code>), with two “get attribute” child calls. We can iterate over the children manually.</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>call <span class="op">=</span> strip_symbolic(_.hp <span class="op">/</span> _.mpg)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> arg <span class="kw">in</span> call.args:</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(arg, Call):</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"child call:"</span>, arg)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"number of kwargs:"</span>, <span class="bu">len</span>(call.kwargs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>child call: _.hp
child call: _.mpg
number of kwargs: 0</code></pre>
</div>
</div>
<p>There are also some Call methods designed to make this easier. The first method, map_subcalls, runs a function on each subcall.</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>call <span class="op">=</span> strip_symbolic(_.hp <span class="op">/</span> _.mpg)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>args, kwargs <span class="op">=</span> call.map_subcalls(<span class="bu">repr</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'args:'</span>, args)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'kwargs:'</span>, kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>args: ('_.hp', '_.mpg')
kwargs: {}</code></pre>
</div>
</div>
<p>The second method, map_replace, does the same thing, but replaces the child call the result.</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>call.map_replace(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> child: BinaryOp(<span class="st">"__getitem__"</span>, <span class="op">*</span>child.args, <span class="op">**</span>child.kwargs)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>_['hp'] / _['mpg']</code></pre>
</div>
</div>
<section id="example-replace_attr" class="level3">
<h3 class="anchored" data-anchor-id="example-replace_attr">Example: replace_attr</h3>
<p>In the Lazy expressions section, we showed off a function that could replace pieces of a Call.</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>replace_attr(_.hp.mean(), <span class="st">"hp"</span>, <span class="st">"some_other_name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>_.some_other_name.mean()</code></pre>
</div>
</div>
<p>Here is the full code for <code>replace_attr</code>.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> strip_symbolic, Call, _, BinaryOp</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> replace_attr(call, src, dst):</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># just in case we pass a Symbolic</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    call <span class="op">=</span> strip_symbolic(call)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that is _.&lt;src&gt;, or the last part of _.abc.&lt;src&gt;</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call.func <span class="op">==</span> <span class="st">"__getattr__"</span> <span class="kw">and</span> call.args[<span class="dv">1</span>] <span class="op">==</span> src:</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># eg: obj = _, src_attr = "hp"</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>        obj, src_attr <span class="op">=</span> call.args</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recreate call, but with dst as the attribute</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BinaryOp(<span class="st">"__getattr__"</span>, obj, dst)</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> call.map_replace(<span class="kw">lambda</span> child: replace_attr(child, src, dst))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="callvisitor" class="level3">
<h3 class="anchored" data-anchor-id="callvisitor">CallVisitor</h3>
<p>The <code>siuba.siu</code> module implements a common class called a visitor. Using a visitor allows you to customize a translation, depending on the kind of Call (or child call) you are working on. This is nearly identical to the class of the same name in python’s built in <code>ast</code> module.</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> siuba.siu <span class="im">import</span> _, strip_symbolic, CallVisitor</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyVisitor(CallVisitor):</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit___getattr__(<span class="va">self</span>, node):</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'get attribute:'</span>, node.args[<span class="dv">1</span>])</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.generic_visit(node)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit___call__(<span class="va">self</span>, node):</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'call'</span>, node.args[<span class="dv">0</span>])</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.generic_visit(node)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>call <span class="op">=</span> strip_symbolic(_.a.b.c() <span class="op">+</span> _.x)</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>MyVisitor().visit(call)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>call _.a.b.c
get attribute: c
get attribute: b
get attribute: a
get attribute: x</code></pre>
</div>
</div>
<p>To learn more, see the developer docs <a href="developer/call_trees.Rmd">“Call tree processing”</a>, <a href="developer/sql-translators.ipynb">“SQL translators”</a>. Moreover, the <a href="https://github.com/machow/siuba/blob/master/examples/architecture/004-user-defined-functions.ipynb">architecture decision record on user defined functions</a>, lays out the rationale behind siuba’s translation tools.</p>
</section>
</section>
<section id="backends" class="level2">
<h2 class="anchored" data-anchor-id="backends">Backends</h2>
<blockquote class="blockquote">
<p>🚧This section is a work in progress. See THIS DOC (TODO) for a tutorial on the SQL backend.</p>
</blockquote>
<p>Reference to…</p>
<ul>
<li>SQL UDF example</li>
<li>ADR on call trees and SQL</li>
</ul>
</section>
<section id="nested-data" class="level2">
<h2 class="anchored" data-anchor-id="nested-data">Nested data</h2>
<blockquote class="blockquote">
<p>🚧This section is a work in progress</p>
</blockquote>
<p>A final piece of siuba–which is more an area of active research–is how to effectively nest data. For example, can a user make a column, where each entry is a DataFrame, or fitted model? This approach is a critical component to R libraries like dplyr, as it allows users to flexibly handle hierarchical data.</p>
<p>For nesting to work with a backend like pandas, we need:</p>
<ol type="1">
<li>DataFrame creation to be very fast (currently not the case).</li>
<li>Strategies for handling combining many DataFrames (works well in pandas).</li>
</ol>
<p>Unfortunately, <strong>siuba is stuck without quick DataFrame creation</strong>. Intriguingly, aspects of this situation mirror / anticipate part of the developmental trajectory of dplyr, which implemented a stripped down form of <code>data.frame</code> called a tibble. Fortunately for siuba, the pandas DataFrame has well-documented options for subclassing, so we may be able to get away with a stripped down, fast DataFrame implementation for restricted cases.</p>
<p>A stripped down DataFrame might involve…</p>
<ul>
<li>removing most of the index (or essentially no-op’ing it)</li>
<li>very little type conversion (so expensive conversions happen at the very end of a table verb)</li>
</ul>
<p>For more details, see the blog post, <a href="https://mchow.com/posts/2020-02-11-dplyr-in-python/">“What would it take to recreate dplyr in python?”</a>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../develop/backend_pandas.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Pandas backend</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../develop/sql-translators.html" class="pagination-link">
        <span class="nav-page-text">SQL translators</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>